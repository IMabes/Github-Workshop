name: C# Homework Tests

# pull_request_target kullanarak fork'lardan gelen PR'lara da yorum yazabiliyoruz
on:
  pull_request_target:
    paths:
      - 'homeworks/csharp-fundamentals/**/submissions/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    name: Validate & Test C# Submissions

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          # PR'Ä±n kodunu checkout et (fork dahil)
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Find Changed Files
        id: changed-files
        run: |
          # Base ve head SHA'larÄ± kullanarak deÄŸiÅŸen dosyalarÄ± bul
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          
          # DeÄŸiÅŸen .cs dosyalarÄ±nÄ± bul
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA -- 'homeworks/csharp-fundamentals/**/submissions/*.cs' 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
            echo "DeÄŸiÅŸen C# submission dosyasÄ± bulunamadÄ±."
          else
            echo "any_changed=true" >> $GITHUB_OUTPUT
            echo "all_changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "DeÄŸiÅŸen dosyalar:"
            echo "$CHANGED_FILES"
          fi

      - name: Validate File Names
        id: validate-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ Dosya AdÄ± KontrolÃ¼"
          echo "===================="
          
          VALID=true
          INVALID_FILES=""
          VALID_FILES=""
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            filename=$(basename "$file")
            echo "Kontrol ediliyor: $filename"
            
            # Check format: ProblemX_123456789.cs
            if [[ ! $filename =~ ^Problem[1-4]_[0-9]{9}\.cs$ ]]; then
              echo "âŒ HATA: $filename formatÄ± yanlÄ±ÅŸ!"
              echo "   Beklenen: ProblemX_OGRENCI_NO.cs (9 haneli numara)"
              INVALID_FILES="${INVALID_FILES}- \`${filename}\`\n"
              VALID=false
            else
              echo "âœ… Format doÄŸru: $filename"
              VALID_FILES="${VALID_FILES}${file}\n"
            fi
          done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
          
          echo "valid_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALID_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$VALID" = false ]; then
            echo ""
            echo "âš ï¸ BazÄ± dosya adlarÄ± yanlÄ±ÅŸ formatta!"
            echo "invalid_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$INVALID_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… TÃ¼m dosya adlarÄ± doÄŸru formatta!"
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Run All Tests
        id: run-tests
        if: steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true'
        run: |
          echo "ğŸ§ª Testler BaÅŸlÄ±yor"
          echo "==================="
          
          ALL_PASSED=true
          TOTAL_SCORE=0
          RESULTS_TABLE="| Problem | Dosya | Puan | Durum |\n|---------|-------|------|-------|\n"
          FAILED_DETAILS=""
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            # Problem numarasÄ±nÄ± dosya yolundan Ã§Ä±kar
            if [[ "$file" =~ problem-([1-4])/submissions/ ]]; then
              problem_num="${BASH_REMATCH[1]}"
              PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
              filename=$(basename "$file")
              
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  Problem $problem_num - $filename"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Create temp project
              TEMP_DIR=$(mktemp -d)
              cp "$file" "$TEMP_DIR/Problem${problem_num}.cs"
              cp "$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "$TEMP_DIR/"
              
              cd "$TEMP_DIR"
              dotnet new console -n TestProject -o . --force > /dev/null 2>&1
              
              # Run tests and capture output
              set +e
              TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1)
              TEST_EXIT_CODE=$?
              set -e
              
              echo "$TEST_OUTPUT"
              
              # Parse score from output
              SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[\d.]+' | head -1 || echo "0")
              [ -z "$SCORE" ] && SCORE="0"
              
              # Determine status
              if [ "$TEST_EXIT_CODE" -eq 0 ]; then
                STATUS="âœ… GeÃ§ti"
              else
                STATUS="âŒ KaldÄ±"
                ALL_PASSED=false
                
                # Extract failed tests for details
                FAILS=$(echo "$TEST_OUTPUT" | grep "âŒ" | head -5 || true)
                if [ -n "$FAILS" ]; then
                  FAILED_DETAILS="${FAILED_DETAILS}\n**Problem ${problem_num} - BaÅŸarÄ±sÄ±z Testler:**\n\`\`\`\n${FAILS}\n\`\`\`\n"
                fi
              fi
              
              # Add to results table
              RESULTS_TABLE="${RESULTS_TABLE}| Problem ${problem_num} | \`${filename}\` | ${SCORE}/25 | ${STATUS} |\n"
              
              TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
              
              cd - > /dev/null
              rm -rf "$TEMP_DIR"
            fi
          done <<< "${{ steps.validate-files.outputs.valid_files }}"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š TOPLAM SONUÃ‡: $TOTAL_SCORE / 100 puan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Set outputs
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          echo "all_passed=$ALL_PASSED" >> $GITHUB_OUTPUT
          
          # Save results for comment
          echo "results_table<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "failed_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAILED_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Don't exit with error here - let the comment step run first

      - name: Generate Job Summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "### âŒ Dosya AdÄ± HatasÄ±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate-files.outputs.invalid_files }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Beklenen format:** \`ProblemX_OGRENCI_NO.cs\` (9 haneli numara)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.run-tests.outputs.all_passed }}" = "true" ]; then
            echo "### âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.run-tests.outputs.results_table }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ Tebrikler!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ BazÄ± Testler BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.run-tests.outputs.results_table }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.run-tests.outputs.failed_details }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š [GitHub Workshop Wiki](https://github.com/Furk4nBulut/Github-Workshop/wiki)" >> $GITHUB_STEP_SUMMARY

      - name: âœ… BaÅŸarÄ±lÄ± - PR'a Yorum Ekle
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true' && steps.run-tests.outputs.all_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.run-tests.outputs.total_score }}';
            const table = `${{ steps.run-tests.outputs.results_table }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… C# Ã–dev Testleri BaÅŸarÄ±lÄ±!

            ${table}

            **Toplam Puan:** ${score} / 100

            ---
            ğŸ‰ **Tebrikler!** TÃ¼m testler geÃ§ti. PR merge edilebilir.

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            });

      - name: âŒ Dosya FormatÄ± HatasÄ± - PR'a Yorum Ekle
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const invalidFiles = `${{ steps.validate-files.outputs.invalid_files }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Dosya AdÄ± HatasÄ±

            AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:

            ${invalidFiles}

            ### ğŸ“‹ DoÄŸru Format
            \`ProblemX_OGRENCI_NO.cs\` (9 haneli Ã¶ÄŸrenci numarasÄ±)

            **Ã–rnek:** \`Problem1_210316011.cs\`

            ---
            âŒ **PR merge edilemez.** LÃ¼tfen dosya adÄ±nÄ± dÃ¼zeltin.

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            });

      - name: âš ï¸ Test BaÅŸarÄ±sÄ±z - PR'a Yorum Ekle
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true' && steps.run-tests.outputs.all_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.run-tests.outputs.total_score }}' || '0';
            const table = `${{ steps.run-tests.outputs.results_table }}`;
            const failedDetails = `${{ steps.run-tests.outputs.failed_details }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ C# Ã–dev Testleri BaÅŸarÄ±sÄ±z

            ${table}

            **Toplam Puan:** ${score} / 100

            ---

            ### âŒ BaÅŸarÄ±sÄ±z Test DetaylarÄ±
            ${failedDetails}

            ---

            ### ğŸ’¡ Ã–neriler
            - Hata mesajlarÄ±nÄ± dikkatlice okuyun
            - Fonksiyon isimlerinin doÄŸru olduÄŸundan emin olun
            - DÃ¶nÃ¼ÅŸ tiplerini kontrol edin
            - README dosyasÄ±nÄ± tekrar okuyun

            ---
            âŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor.

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            });

      - name: Final Status Check
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "âŒ Dosya adÄ± formatÄ± yanlÄ±ÅŸ!"
            exit 1
          fi
          
          if [ "${{ steps.run-tests.outputs.all_passed }}" = "false" ]; then
            echo "âŒ BazÄ± testler baÅŸarÄ±sÄ±z!"
            exit 1
          fi
          
          echo "âœ… TÃ¼m kontroller baÅŸarÄ±lÄ±!"
